# 考察メモ

## 9/17

### 状態

```rust
struct State {
    grid: Vec<Vec<Option<Point>>>,
    points: Vec<Point>,
    edges: Vec<Vec<Vec<bool>>>,
}
```

### 点が持つ情報

```rust
struct Pos {
    x: i64,
    y: i64,
}

struct Point {
    // 追加された点かどうか
    is_added: bool,
    // 各方向にある最も近い点
    // 方向を0~7の値に決める
    nearest_points: Vec<Option<Point>>,
    // その点を使って作った点
    used_points: Vec<Point>,
    // 各方向が長方形の辺に使われているか
    used_dir: Vec<bool>,
}
```

### 近傍

- 3点選んで四角を作る
    - ランダムに1点選んで、90度（上と左、左下と左上）の方向に点があれば、新しい点を作る
- 四角を付け替える
```
ooo
xox
```

### 考察

- 1点選んで、90度（上と左、左下と左上）の方向に点があれば、新しい点を作れる
    - 1番近い点しかだめ
    - 新しい点と繋ごうとしている点の間に点があってもダメ
- なるべく遠いところに点を作りたい
    - 斜めが必要
        - でも斜めだけだと伸ばせない
    - 斜めと垂直はある程度区別して扱う必要がありそう
- ある点を消す時には、その点を使った長方形によってできた点はロールバックしなければいけない
    - 作った点を、材料の点は覚えておく
        - 再帰的に消す必要がある
- 1つの点は最大4つの四角に使える
    - 垂直2、斜め2
- 正方形を作ると、対角線を斜め四角の辺として使える
    - 評価高めにする?

## 9/18

- 四角を削除する処理を追加
- 再帰的に削除しているけど
    - 処理順が保証されていない
        - 最後にトポロジカルソートし直す
            - だけじゃ駄目かも
            - 辺上に点が作られた場合に順序を保証する必要がある
        - idを振ることで解決
    - 再帰しすぎる
        - recursion_limitを設ける
- O(n)の処理はBinaryHeapと置き換えてみる
    - それか、bufferみたいにオンオフだけ切り替える

## 9/19

- 時間伸ばしても（10s）スコアはほとんど伸びない
    - 近傍を工夫したい
    - 遠いところに点が作れるようになりたい
- 一気に遠いところに作るのではなく、ちょっとずつ伸ばすのが良い
    - ある程度人為的にやる必要がありそう
    - それかいい感じのスコア関数を作るか
    - あくまで仮説、違う可能性を一応考えておく
- 斜めと垂直が独立に見えるけど、そうではない
    - 偶奇が大事
    - 一つずれると作れなくなる
- 目標を決めて、その状態になりやすい近傍を考える
- 点同士の依存関係、割と大きい木になっているっぽい
    - 最初が大事?
    - でかい斜めは作らない方がいい?
- 伸ばさない方向に斜めを重ねちゃうと、伸ばしたい方に伸びなくなる
- 真ん中は疎でもいい
- 角は進出できる
    - でも難しい、孤立点になりそう

### TODO

- 近傍の採用率を計測する
- スコアの遷移の可視化
- 焼きなまし過程を可視化する（優先度低め）
    - ビジュアライザを使う

### 高速化

- O(n)の解消
- recursion_limitを設ける
    - 消す前に、繋がっている点の数を求める
- 不要な`Pos.clone()`を消す

### 近傍

- 付け替える
    - この位置関係になっているxを探す
    ```
       o

    o  x   o
    ```
    - 結果: スコア下がる
        - 試行回数が下がってる
        - 時間長くしても（30s）、単純に消す方に負けてる
    - 原因探す、改善
- 既にある辺の途中に点を作る
    - 難しい
- 連鎖的に四角を作る
    - 二つの点から作る
        - 理想の位置の点が作れるか、連鎖的に
- dfsっぽく伸ばす
- 消して作る
    - 辺を共有することを許す
    - 後で壊す

- 点の選び方を工夫する

### スコア計算

- 四角が作りやすくなると評価
- なるべく小さい四角が良い
    - 疎な盤面だと小さい四角は作りづらい
- 現状`Command::Add`が無条件に採用なので、何か一つスコア項を加える

## 9/20

- ちょっとずつ伸ばすのは点がないと難しい
    - 割と焼きなましで作れている
- N、Mによって全然課題が違う
    - (M / N*N)で分けた方がいいかも
- 同じケースでも点数のブレが割とある
    - 同じケースでうまくいってる時とない時を観察する
    - 0042.txt
        - うまくいってる時は塊ができている
    - 0020.txt
        - 遠くに点を作っている
- スコアに足してる項は本当に改善してるか確認する
    - 最後でいい

### 高速化

- O(n)の解消
    - そんなに変わらなかった
- recursion_limitを設ける
    - 消す前に、繋がっている点の数を求める
    - recursion_limitは後で調整

### スコア計算

```
total: 107209644
(1742236, '0098')
(1598767, '0038')
(1586661, '0092')
(1469426, '0013')
(1442859, '0048')
(1432605, '0063')
(1371600, '0042')
(1371248, '0065')
(1361530, '0016')
(1353586, '0022')
(690380, '0000')
(796408, '0017')
(797280, '0062')
(813683, '0028')
(817548, '0079')
(820274, '0002')
(835806, '0018')
(842112, '0051')
(842864, '0020')
(847332, '0060')
ave: 1072096.44
```

## 9/21

```
      |   30~59   60~89  90~119 120~149 150~179 180~209 210~239 240~269 270~299 300~329
---------------------------------------------------------------------------------------
31~35 |  969638 1134116 1266978     nan     nan     nan     nan     nan     nan     nan
36~40 |  900206 1043687 1171614 1255415     nan     nan     nan     nan     nan     nan
41~45 |  896264  986749 1078027 1158464 1181315     nan     nan     nan     nan     nan
46~50 |  872817  990311 1004780 1071167 1147490 1141331     nan     nan     nan     nan
51~55 |  884832  945488  978726  983503 1059670 1093752 1085771 1084628     nan     nan
56~60 |  762923  908532  941637  953196  941471  968535  970087 1010017  988966 1003020
```

- 追加の項あり

```
ave: 1059238.084
      |   30~59   60~89  90~119 120~149 150~179 180~209 210~239 240~269 270~299 300~329
---------------------------------------------------------------------------------------
31~35 |  986129 1185950 1315236     nan     nan     nan     nan     nan     nan     nan
36~40 |  932324 1088868 1273608 1452531     nan     nan     nan     nan     nan     nan
41~45 |  920723 1028714 1110791 1163003 1291191     nan     nan     nan     nan     nan
46~50 |  946023  978760 1045693 1138155 1179749 1132275     nan     nan     nan     nan
51~55 |  861090  942636  986035  979218 1069632 1132851 1157343 1067696     nan     nan
56~60 |  862811  871807  937538  948948  974032  972371  977586  980412  966758  957298
```

- 追加の項なし

```
ave: 1053764.29
      |   30~59   60~89  90~119 120~149 150~179 180~209 210~239 240~269 270~299 300~329
---------------------------------------------------------------------------------------
31~35 |  992976 1181854 1365716     nan     nan     nan     nan     nan     nan     nan
36~40 |  921701 1058274 1245623 1286947     nan     nan     nan     nan     nan     nan
41~45 |  913822  993860 1074276 1175350 1288058     nan     nan     nan     nan     nan
46~50 |  855365  968580 1078752 1091795 1189719 1188475     nan     nan     nan     nan
51~55 |  887466  941013  989776  981771 1073392 1124193 1133208 1138397     nan     nan
56~60 |  789882  921655  960318  969607  961258  965799  960927 1004479  979255  985975
```

- この形が強い

```
o o
oo
```
```
 oo
oo
```
```
ooo
 o
```
```
ooo
o
```

### 方向性

- 強い近傍を考える
    - 外側が大事
        - 優先的に変形させたい
    - 既にできているのに付け足したい
- スコアを見直す
    - 違反するパターン（伸ばしちゃいけない方向に重ねる）を悪く評価する
        - 違反するパターンが洗い出せていない
- 初期解をよくする
    - 2sくらい使って初期解を作ることはできる
    - 最初と最後で評価関数を変える

## 9/23

- 伸ばしたいケースを考える
    - 0019, 0024を伸ばす

### 近傍の候補

- 何個も一気に作る
- 一個架空の点を作って、それを帰納的に作る
- 途中で分割して作る

### スコア

- 繋ぎやすさを表現したスコアが欲しい
